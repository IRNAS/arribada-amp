// [var#debug] sets debugging level
// 0 - normal, 1 - 5GHz always on, 2 - ESP always on and previous

On battery#voltage do // undervoltage protection
  if [battery#voltage]<3200
      gpio,15,0 //turn all off
      gpio,12,0
      gpio,14,0
      TaskValueSet,3,1,0 // let RPi know it should turn off
  endif
endon

On System#Boot do //on boot
  timerSet,2,120      // set timer1 in 30s
endon

On ldr#lux do // undervoltage protection
  if [ldr#lux]>40 // turn things on
    gpio,15,1
    gpio,12,1
    TaskValueSet,3,1,1 // let RPi know it should be on
  endif
  if [ldr#lux]<10
    TaskValueSet,3,1,0 // let RPi know it should turn off
    timerSet,1,45     // go to sleep 120s after sleep condition is met
  endif
endon

On Rules#Timer=1 do  // going to sleep
 if [var#debug]<2
  deepSleep,600 // go to sleep for 600s
 endif
endon

On Rules#Timer=2 do  // turn router on
 gpio,14,[var#rpi] // router power
 TaskValueSet,3,3,[var#rpi]
 timerSet,3,600 // keep on for 10min
 Event reconnect
endon

On Rules#Timer=3 do  // going to sleep
 if [var#debug]<1
   gpio,14,0 // router power
   TaskValueSet,3,3,0
 endif
 timerSet,2,3000 // keep off for 30min
endon

On debugon do
 TaskValueSet,3,4,1
endon

On debugoff do
 TaskValueSet,3,4,0
endon

On reconnect do
 WifiDisconnect
 WifiConnect
endon

On System#Sleep do //on sleep
 gpio,15,0
 gpio,12,0
 gpio,14,0
endon
